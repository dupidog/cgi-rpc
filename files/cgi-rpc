#!/bin/sh 

DEBUG=$(uci get cgirpc.debug.enabled)
RPC_FUNC_PATH=$(uci get cgirpc.common.rpc_func_path)

if [ "x$RPC_FUNC_PATH" = "x" ]; then
RPC_FUNC_PATH='/usr/lib/cgi-rpc/rpc-func'
fi

TRANS_QS=$(echo $QUERY_STRING | urldecode | JSON.sh)
METHOD=$(echo "$TRANS_QS" | awk '$1 == "[\"method\"]" {print $2}' | sed -e "s/\"\|\[\|\]//g")
TARGET=$(echo "$TRANS_QS" | awk '$1 == "[\"target\"]" {print $2}' | sed -e "s/\"\|\[\|\]//g")

echo "Content-type: text/json"
echo ""

if [ "$DEBUG" != "0" -a "x$DEBUG" != "x" ]; then
echo "--------Debug JSON---------"
echo "Translated query string: $TRANS_QS"
echo "Method: $METHOD"
echo "Target: $TARGET"
echo "Run script: rpc-func/$METHOD/$TARGET"
echo "---------------------------"
fi

RET=$($RPC_FUNC_PATH/$METHOD/$TARGET "$TRANS_QS" $DEBUG)
echo $RET
